<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Google Fonts for animated emojis -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Base Effects */
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .dark-gradient {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        .search-glow:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        /* Movie Card Styles */
        .movie-card {
            transition: all 0.3s ease;
            transform: translateY(0);
            min-width: 200px;
            max-width: 20%;
            flex: 1 1 20%;
            padding: 1rem;
        }
        
        /* Mobile responsive styles for watchlist buttons */
        @media (max-width: 640px) {
            .movie-card {
                min-width: 160px;
                max-width: 180px;
                padding: 0.75rem;
            }
            
            .watchlist-btn {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
                line-height: 1rem !important;
            }
            
            .watchlist-btn i {
                width: 0.875rem !important;
                height: 0.875rem !important;
                margin-right: 0.25rem !important;
            }
        }
        
        .movie-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .movie-card .poster-container {
            aspect-ratio: 2/3;
            width: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            margin-bottom: 1rem;
            height: auto;
            max-height: 280px;
        }
        
        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
            display: block;
            max-height: 280px;
        }

        /* Adult content blur */
        .poster-blur {
            filter: blur(14px) brightness(0.7) saturate(0.8);
            transform: scale(1.02);
        }
        .adult-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
            font-weight: 700;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.35);
        }

        /* Poster Details Button */
        .poster-details-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .movie-card .poster-container:hover .poster-details-btn {
            opacity: 1;
        }
        
        .poster-details-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .trending-number {
            position: absolute;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.9), rgba(139, 0, 0, 0.9));
            color: white;
            font-weight: bold;
            font-size: 1.8rem;
            width: 60px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            clip-path: polygon(0 0, 70% 0, 100% 50%, 70% 100%, 0 100%);
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }

        /* Scrolling */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            gap: 1.5rem;
            position: relative;
        }

        /* Navigation Controls */
        .section-navigation {
            position: relative;
            margin-bottom: 1rem;
        }

        .nav-controls {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            color: rgb(196, 181, 253);
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-btn i {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Skeleton card styles to avoid flicker */
        .skeleton-card {
            min-width: 200px;
            max-width: 20%;
            flex: 1 1 20%;
        }
        .skeleton-animate {
            background: linear-gradient(90deg, rgba(75,85,99,0.35) 25%, rgba(75,85,99,0.55) 37%, rgba(75,85,99,0.35) 63%);
            background-size: 400% 100%;
            animation: shimmer 1.4s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        /* Scroll indicator */
        .scroll-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .scroll-indicator .scroll-progress {
            height: 100%;
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.6), rgba(139, 92, 246, 0.8));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Hide scrollbars */
        .horizontal-scroll {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .horizontal-scroll::-webkit-scrollbar {
            display: none;
        }

        /* Touch/swipe support */
        .horizontal-scroll {
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
        }

        .movie-card {
            scroll-snap-align: start;
        }





        /* Keyboard navigation focus indicators */
        .keyboard-navigation .nav-btn:focus {
            outline: 2px solid rgba(139, 92, 246, 0.8);
            outline-offset: 2px;
        }

        .keyboard-navigation .nav-btn:focus-visible {
            outline: 2px solid rgba(139, 92, 246, 0.8);
            outline-offset: 2px;
        }

        /* Focus styles for all interactive elements */
        .nav-btn:focus-visible {
            outline: 2px solid rgba(139, 92, 246, 0.8);
            outline-offset: 2px;
        }



        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 400px;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(21, 128, 61, 0.9));
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .toast.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .toast.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(185, 28, 28, 0.9));
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Language Badges */
        .language-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 9999px;
            color: rgb(196, 181, 253);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .language-badge .remove-btn {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 0.75rem;
        }
        
        .language-badge .remove-btn:hover {
            background: rgba(239, 68, 68, 1);
        }

        /* Mood Card Styles */
        .mood-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .mood-btn.selected {
            border-color: rgb(139, 92, 246) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
        }
        
        .mood-btn:hover {
            transform: translateY(-2px);
        }

        /* Google Emoji Styling */
        .google-emoji {
            font-family: 'Noto Color Emoji', sans-serif;
            font-size: 2.5rem;
            line-height: 1;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        /* Language Selection */
        .language-select-container {
            position: relative;
        }
        
        .language-option {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .language-option:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .language-option.selected {
            background: rgba(139, 92, 246, 0.2);
            color: rgb(196, 181, 253);
        }

        /* Search Suggestions Styles */
        .search-suggestion-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .search-suggestion-item:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateX(4px);
        }
        
        .search-suggestion-item.selected {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }
        
        .suggestion-poster {
            width: 3rem;
            height: 4.5rem;
            object-fit: cover;
            border-radius: 0.5rem;
            flex-shrink: 0;
        }
        
        .suggestion-info {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-title {
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-meta {
            font-size: 0.875rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .suggestion-year {
            color: #6b7280;
        }
        
        .suggestion-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #fbbf24;
        }
        
        .no-suggestions {
            padding: 1rem;
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
        
        .suggestions-loading {
            padding: 1rem;
            text-align: center;
            color: #9ca3af;
        }

        /* Responsive Design */
        @media (max-width: 1279px) {
            .movie-card {
                min-width: 220px;
                max-width: 32%;
                flex: 1 1 32%;
                padding: 0.75rem;
            }
            .movie-card .poster-container,
            .movie-card img {
                max-height: 220px;
            }
        }

        @media (max-width: 767px) {
            .movie-card {
                min-width: 140px;
                max-width: 48%;
                flex: 1 1 48%;
                padding: 0.5rem;
            }
            .movie-card .poster-container,
            .movie-card img {
                min-height: 140px;
                max-height: 180px;
            }
            
            #watchlist-content .bg-gray-800\/30 {
                min-width: 110px !important;
                max-width: 140px !important;
                padding: 0.5rem !important;
            }
            #watchlist-content img {
                min-height: 100px !important;
                max-height: 140px !important;
            }
            
            /* Mobile search suggestions */
            .search-suggestion-item {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            .suggestion-poster {
                width: 2.5rem;
                height: 3.75rem;
            }
            
            .suggestion-title {
                font-size: 0.875rem;
            }
            
            .suggestion-meta {
                font-size: 0.75rem;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="dark-gradient min-h-screen text-white">
    <!-- Header -->
    <header class="sticky top-0 z-50 glass-effect">
        <nav class="container mx-auto px-4 md:px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl shadow-lg">
                        <i data-lucide="film" class="w-6 h-6"></i>
                    </div>
                    <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                        Movie Explorer
                    </h1>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    <button id="profile-btn" class="relative flex items-center justify-center w-11 h-11 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 shadow-lg border-2 border-white/10 hover:scale-105 transition-transform ring-2 ring-purple-400/30 focus:outline-none">
                        <img id="profile-pic" src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-md">
                    </button>
                    <button id="watchlist-btn" class="relative p-2 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition-colors">
                        <i data-lucide="bookmark" class="w-5 h-5"></i>
                        <span id="watchlist-count" class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 md:px-6 py-8">
        <!-- Search Section -->
        <section class="mb-12">
            <div class="max-w-4xl mx-auto">
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    <input 
                        id="search-input" 
                        type="text" 
                        placeholder="Search for movies..."
                        class="w-full pl-12 pr-4 py-4 bg-gray-800/50 border border-gray-700 rounded-2xl focus:outline-none search-glow focus:border-purple-500 transition-all text-white placeholder-gray-400"
                        autocomplete="off"
                    >
                    <button 
                        id="search-btn"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-white bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-xl focus:outline-none"
                    >
                        Search
                    </button>
                    
                    <!-- Search Suggestions Dropdown -->
                    <div id="search-suggestions" class="absolute top-full left-0 right-0 mt-2 bg-gray-800/95 border border-gray-700 rounded-xl shadow-2xl backdrop-blur-xl z-50 max-h-80 overflow-y-auto hidden">
                        <div id="suggestions-content" class="p-2">
                            <!-- Suggestions will be populated here -->
                        </div>
                    </div>
                </div>
                
            </div>
        </section>

        <div id="loading-spinner" class="flex justify-center my-6 hidden">
            <svg class="animate-spin h-10 w-10 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
        </div>

        <!-- Search Results -->
        <section id="search-results" class="mb-12 hidden">
            <div class="section-navigation">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="search" class="w-6 h-6 mr-3 text-purple-400"></i>
                    Search Results
                </h2>
                <div class="nav-controls">
                    <button class="nav-btn" onclick="scrollSection('search-movies', 'left')" title="Scroll Left (←)">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <button class="nav-btn" onclick="scrollSection('search-movies', 'right')" title="Scroll Right (→)">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="horizontal-scroll scrollbar-hide pb-4" id="search-movies-container">
                <div id="search-movies" class="flex gap-6"></div>
                <div class="scroll-indicator">
                    <div class="scroll-progress" id="search-movies-progress"></div>
                </div>
            </div>
        </section>

        <!-- Recommendations -->
        <section id="recommendations" class="mb-12 hidden">
            <div class="section-navigation">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="target" class="w-6 h-6 mr-3 text-green-400"></i>
                    You Might Also Like
                </h2>
                <div class="nav-controls">
                    <button class="nav-btn" onclick="scrollSection('recommendation-movies', 'left')" title="Scroll Left (←)">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <button class="nav-btn" onclick="scrollSection('recommendation-movies', 'right')" title="Scroll Right (→)">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="horizontal-scroll scrollbar-hide pb-4" id="recommendation-movies-container">
                <div id="recommendation-movies" class="flex gap-6"></div>
                <div class="scroll-indicator">
                    <div class="scroll-progress" id="recommendation-movies-progress"></div>
                </div>
            </div>
        </section>

        <!-- Trending Movies -->
        <section class="mb-12">
            <div class="section-navigation">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="trending-up" class="w-6 h-6 mr-3 text-red-400"></i>
                    Trending Now
                </h2>
                <div class="nav-controls">
                    <button class="nav-btn" onclick="scrollSection('trending-movies', 'left')" title="Scroll Left (←)">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <button class="nav-btn" onclick="scrollSection('trending-movies', 'right')" title="Scroll Right (→)">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="horizontal-scroll scrollbar-hide pb-4" id="trending-movies-container">
                <div id="trending-movies" class="flex gap-6">
                    <div class="movie-card bg-gray-800/30 rounded-2xl p-4 animate-pulse min-w-[200px]">
                        <div class="bg-gray-700 rounded-xl h-64 mb-4"></div>
                        <div class="bg-gray-700 h-4 rounded mb-2"></div>
                        <div class="bg-gray-700 h-3 rounded mb-2"></div>
                    </div>
                </div>
                <div class="scroll-indicator">
                    <div class="scroll-progress" id="trending-movies-progress"></div>
                </div>
            </div>
        </section>

        <!-- Top Rated Movies -->
        <section class="mb-12">
            <div class="section-navigation">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="award" class="w-6 h-6 mr-3 text-yellow-400"></i>
                    Top Rated
                </h2>
                <div class="nav-controls">
                    <button class="nav-btn" onclick="scrollSection('toprated-movies', 'left')" title="Scroll Left (←)">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <button class="nav-btn" onclick="scrollSection('toprated-movies', 'right')" title="Scroll Right (→)">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="horizontal-scroll scrollbar-hide pb-4" id="toprated-movies-container">
                <div id="toprated-movies" class="flex gap-6">
                    <div class="bg-gray-800/30 rounded-2xl p-4 animate-pulse min-w-[200px]">
                        <div class="bg-gray-700 rounded-xl h-64 mb-4"></div>
                        <div class="bg-gray-700 h-4 rounded mb-2"></div>
                        <div class="bg-gray-700 h-3 rounded mb-2"></div>
                    </div>
                </div>
                <div class="scroll-indicator">
                    <div class="scroll-progress" id="toprated-movies-progress"></div>
                </div>
            </div>
        </section>

        <!-- Recommended for You -->
        <section id="user-recommendations" class="mb-12">
            <div class="section-navigation">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="heart" class="w-6 h-6 mr-3 text-pink-400"></i>
                    Recommended for You
                </h2>
                <div class="nav-controls">
                    <button class="nav-btn" onclick="scrollSection('user-recommendation-movies', 'left')" title="Scroll Left (←)">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    <button class="nav-btn" onclick="scrollSection('user-recommendation-movies', 'right')" title="Scroll Right (→)">
                        <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="horizontal-scroll scrollbar-hide pb-4" id="user-recommendation-movies-container">
                <div id="user-recommendation-movies" class="flex gap-6">
                    <div class="text-center py-12 text-gray-400">
                        <i data-lucide="heart" class="w-16 h-16 mx-auto mb-4"></i>
                        <p>Watch more movies to get personalized recommendations</p>
                    </div>
                </div>
                <div class="scroll-indicator">
                    <div class="scroll-progress" id="user-recommendation-movies-progress"></div>
                </div>
            </div>
        </section>

    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-900 rounded-3xl p-8 max-w-4xl w-full max-h-[85vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold flex items-center">
                        <i data-lucide="user" class="w-8 h-8 mr-3 text-purple-400"></i>
                        User Profile
                    </h2>
                    <button id="close-profile-modal" class="p-3 bg-gray-800 rounded-xl hover:bg-gray-700 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <!-- Profile Picture Section -->
                <div class="flex flex-col md:flex-row items-center md:items-start gap-8 mb-8">
                    <div class="flex flex-col items-center space-y-4">
                        <div class="relative">
                            <img id="profile-pic-large" src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff" alt="Profile" class="w-32 h-32 rounded-full border-4 border-purple-500 shadow-lg">
                            <div class="absolute inset-0 rounded-full bg-gradient-to-br from-purple-500/20 to-pink-500/20"></div>
                        </div>
                        <input type="file" id="profile-pic-input" accept="image/*" class="hidden">
                        <button onclick="document.getElementById('profile-pic-input').click()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 px-6 py-3 rounded-xl text-white font-medium transition-all shadow-lg">
                            <i data-lucide="camera" class="w-4 h-4 mr-2 inline"></i>
                            Change Photo
                        </button>
                    </div>
                    
                    <!-- Basic Info -->
                    <div class="flex-1 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold mb-3 text-purple-300">Full Name</label>
                                <input type="text" id="profile-name-input" placeholder="Enter your name" class="w-full bg-gray-800/70 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition-colors">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-3 text-purple-300">Age</label>
                                <input type="number" id="profile-age-input" min="13" max="100" placeholder="25" class="w-full bg-gray-800/70 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:border-purple-500 focus:outline-none transition-colors">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold mb-3 text-purple-300">Region</label>
                                <select id="profile-region-input" class="w-full bg-gray-800/70 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-purple-500 focus:outline-none transition-colors">
                                    <option value="US">🇺🇸 United States</option>
                                    <option value="IN">🇮🇳 India</option>
                                    <option value="GB">🇬🇧 United Kingdom</option>
                                    <option value="CA">🇨🇦 Canada</option>
                                    <option value="AU">🇦🇺 Australia</option>
                                    <option value="DE">🇩🇪 Germany</option>
                                    <option value="FR">🇫🇷 France</option>
                                    <option value="JP">🇯🇵 Japan</option>
                                    <option value="KR">🇰🇷 South Korea</option>
                                    <option value="BR">🇧🇷 Brazil</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-3 text-purple-300">Preferred Languages</label>
                                
                                <!-- Custom Language Selector -->
                                <div class="language-select-container">
                                    <div class="bg-gray-800/70 border border-gray-600 rounded-xl max-h-24 overflow-y-auto">
                                        <div class="language-option" data-lang="en">
                                            <span class="text-lg">🇺🇸</span>
                                            <span>English</span>
                                        </div>
                                        <div class="language-option" data-lang="hi">
                                            <span class="text-lg">🇮🇳</span>
                                            <span>Hindi</span>
                                        </div>
                                        <div class="language-option" data-lang="es">
                                            <span class="text-lg">🇪🇸</span>
                                            <span>Spanish</span>
                                        </div>
                                        <div class="language-option" data-lang="fr">
                                            <span class="text-lg">🇫🇷</span>
                                            <span>French</span>
                                        </div>
                                        <div class="language-option" data-lang="de">
                                            <span class="text-lg">🇩🇪</span>
                                            <span>German</span>
                                        </div>
                                        <div class="language-option" data-lang="ja">
                                            <span class="text-lg">🇯🇵</span>
                                            <span>Japanese</span>
                                        </div>
                                        <div class="language-option" data-lang="ko">
                                            <span class="text-lg">🇰🇷</span>
                                            <span>Korean</span>
                                        </div>
                                        <div class="language-option" data-lang="pt">
                                            <span class="text-lg">🇵🇹</span>
                                            <span>Portuguese</span>
                                        </div>
                                        <div class="language-option" data-lang="it">
                                            <span class="text-lg">🇮🇹</span>
                                            <span>Italian</span>
                                        </div>
                                        <div class="language-option" data-lang="ru">
                                            <span class="text-lg">🇷🇺</span>
                                            <span>Russian</span>
                                        </div>
                                    </div>
                                    <!-- Hidden select for form compatibility -->
                                    <select id="profile-languages-input" multiple class="hidden">
                                        <option value="en">English</option>
                                        <option value="hi">Hindi</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                        <option value="ja">Japanese</option>
                                        <option value="ko">Korean</option>
                                        <option value="pt">Portuguese</option>
                                        <option value="it">Italian</option>
                                        <option value="ru">Russian</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-400 mt-2">Click to select/deselect languages</p>
                                
                                <!-- Selected Languages Display -->
                                <div id="selected-languages" class="mt-4">
                                    <div class="flex flex-wrap gap-2" id="language-badges"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Mood Section -->
                <div class="mb-8">
                    <label class="block text-sm font-semibold mb-4 text-purple-300">Current Mood</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <button class="mood-btn bg-gradient-to-br from-yellow-500/20 to-orange-500/20 border border-yellow-500/30 hover:from-yellow-500/30 hover:to-orange-500/30 p-4 rounded-xl text-center transition-all" data-mood="happy">
                            <div class="google-emoji">
                                <picture>
                                    <source srcset="https://fonts.gstatic.com/s/e/notoemoji/latest/263a_fe0f/512.webp" type="image/webp">
                                    <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/263a_fe0f/512.gif" alt="😃" width="32" height="32">
                                </picture>
                            </div>
                            <div class="text-sm font-medium">Happy</div>
                        </button>
                        <button class="mood-btn bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30 hover:from-orange-500/30 hover:to-red-500/30 p-4 rounded-xl text-center transition-all" data-mood="excited">
                            <div class="google-emoji">
                                <picture>
                                    <source srcset="https://fonts.gstatic.com/s/e/notoemoji/latest/1f929/512.webp" type="image/webp">
                                    <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f929/512.gif" alt="🤩" width="32" height="32">
                                </picture>
                            </div>
                            <div class="text-sm font-medium">Excited</div>
                        </button>
                        <button class="mood-btn bg-gradient-to-br from-green-500/20 to-emerald-500/20 border border-green-500/30 hover:from-green-500/30 hover:to-emerald-500/30 p-4 rounded-xl text-center transition-all" data-mood="relaxed">
                            <div class="google-emoji">
                                <picture>
                                    <source srcset="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60c/512.webp" type="image/webp">
                                    <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60c/512.gif" alt="😌" width="32" height="32">
                                </picture>
                            </div>
                            <div class="text-sm font-medium">Relaxed</div>
                        </button>
                        <button class="mood-btn bg-gradient-to-br from-blue-500/20 to-cyan-500/20 border border-blue-500/30 hover:from-blue-500/30 hover:to-cyan-500/30 p-4 rounded-xl text-center transition-all" data-mood="adventurous">
                            <div class="google-emoji">
                                <picture>
                                    <source srcset="https://fonts.gstatic.com/s/e/notoemoji/latest/1f920/512.webp" type="image/webp">
                                    <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f920/512.gif" alt="🤠" width="32" height="32">
                                </picture>
                            </div>
                            <div class="text-sm font-medium">Adventurous</div>
                        </button>
                        <button class="mood-btn bg-gradient-to-br from-pink-500/20 to-rose-500/20 border border-pink-500/30 hover:from-pink-500/30 hover:to-rose-500/30 p-4 rounded-xl text-center transition-all" data-mood="romantic">
                            <div class="google-emoji">
                                <picture>
                                    <source srcset="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60d/512.webp" type="image/webp">
                                    <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60d/512.gif" alt="😍" width="32" height="32">
                                </picture>
                            </div>
                            <div class="text-sm font-medium">Romantic</div>
                        </button>
                        <button class="mood-btn bg-gradient-to-br from-purple-500/20 to-indigo-500/20 border border-purple-500/30 hover:from-purple-500/30 hover:to-indigo-500/30 p-4 rounded-xl text-center transition-all" data-mood="mysterious">
                            <div class="google-emoji">
                                <picture>
                                    <source srcset="https://fonts.gstatic.com/s/e/notoemoji/latest/1f914/512.webp" type="image/webp">
                                    <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f914/512.gif" alt="🤔" width="32" height="32">
                                </picture>
                            </div>
                            <div class="text-sm font-medium">Mysterious</div>
                        </button>
                    </div>
                </div>
                
                <!-- Safety Settings -->
                <div class="mb-8 p-6 bg-gray-800/50 rounded-2xl border border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-2">Safety Settings</h3>
                            <p class="text-sm text-gray-400">Control what content you see</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="safe-mode-input" class="w-5 h-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500">
                            <label for="safe-mode-input" class="text-sm font-medium text-white">Safe Mode (Hide Adult Content)</label>
                        </div>
                    </div>
                </div>
                
                <!-- Save Button -->
                <button id="save-profile" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 py-4 rounded-xl text-white font-semibold text-lg transition-all shadow-lg">
                    <i data-lucide="save" class="w-5 h-5 mr-2 inline"></i>
                    Save Profile
                </button>
            </div>
        </div>
    </div>

    <!-- Mood Popup -->
    <div id="mood-popup" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-900 rounded-3xl p-8 max-w-md w-full">
                <h3 class="text-xl font-bold mb-4 text-center">How are you feeling today?</h3>
                <div class="grid grid-cols-2 gap-4">
                    <button class="mood-popup-btn bg-yellow-500/20 hover:bg-yellow-500/30 p-4 rounded-xl text-center" data-mood="happy">
                        <div class="google-emoji">
                            <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60a/512.gif" alt="😊" width="32" height="32">
                        </div>
                        <div class="text-sm">Happy</div>
                    </button>
                    <button class="mood-popup-btn bg-orange-500/20 hover:bg-orange-500/30 p-4 rounded-xl text-center" data-mood="excited">
                        <div class="google-emoji">
                            <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60e/512.gif" alt="🤩" width="32" height="32">
                        </div>
                        <div class="text-sm">Excited</div>
                    </button>
                    <button class="mood-popup-btn bg-green-500/20 hover:bg-green-500/30 p-4 rounded-xl text-center" data-mood="relaxed">
                        <div class="google-emoji">
                            <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60c/512.gif" alt="😌" width="32" height="32">
                        </div>
                        <div class="text-sm">Relaxed</div>
                    </button>
                    <button class="mood-popup-btn bg-blue-500/20 hover:bg-blue-500/30 p-4 rounded-xl text-center" data-mood="adventurous">
                        <div class="google-emoji">
                            <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f920/512.gif" alt="🤠" width="32" height="32">
                        </div>
                        <div class="text-sm">Adventurous</div>
                    </button>
                    <button class="mood-popup-btn bg-pink-500/20 hover:bg-pink-500/30 p-4 rounded-xl text-center" data-mood="romantic">
                        <div class="google-emoji">
                            <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f60d/512.gif" alt="😍" width="32" height="32">
                        </div>
                        <div class="text-sm">Romantic</div>
                    </button>
                    <button class="mood-popup-btn bg-purple-500/20 hover:bg-purple-500/30 p-4 rounded-xl text-center" data-mood="mysterious">
                        <div class="google-emoji">
                            <img src="https://fonts.gstatic.com/s/e/notoemoji/latest/1f914/512.gif" alt="🤔" width="32" height="32">
                        </div>
                        <div class="text-sm">Mysterious</div>
                    </button>
                </div>
                <button id="skip-mood" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-white">
                    Skip for now
                </button>
            </div>
        </div>
    </div>

    <!-- Watchlist Modal -->
    <div id="watchlist-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-900 rounded-3xl p-8 max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i data-lucide="bookmark" class="w-6 h-6 mr-3 text-purple-400"></i>
                        Your Watchlist
                    </h2>
                    <button id="close-modal" class="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="watchlist-content" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <div class="text-center py-12 col-span-full">
                        <i data-lucide="bookmark" class="w-16 h-16 mx-auto text-gray-600 mb-4"></i>
                        <p class="text-gray-400">Your watchlist is empty</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Movie Detail Modal -->
    <div id="movie-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gray-900 rounded-3xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div id="movie-detail-content">
                    <!-- Movie details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Trailer Popup Modal -->
    <div id="trailer-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[999] hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative bg-black rounded-2xl shadow-2xl w-full max-w-3xl" style="aspect-ratio: 16/9;">
                <button onclick="closeTrailerModal()" class="absolute top-3 right-3 z-10 p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors">
                    <i data-lucide="x" class="w-6 h-6 text-white"></i>
                </button>
                <div id="trailer-iframe-container" class="w-full h-full flex items-center justify-center"></div>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // CONFIGURATION & CONSTANTS
        // ===========================================
        const TMDB_API_KEY = "3d3b5cbc09e66409a5686373a4c110e7";
        const TMDB_BASE_URL = "https://api.themoviedb.org/3";
        const IMAGE_BASE_URL = "https://image.tmdb.org/t/p/w500";
        const FALLBACK_POSTER_URL = 'https://dummyimage.com/500x750/1f2937/9ca3af&text=No+Poster';
        const YOUTUBE_BASE_URL = "https://www.youtube.com/watch?v=";

        const LANGUAGE_MAP = {
            'en': { name: 'English', flag: '🇺🇸' },
            'hi': { name: 'Hindi', flag: '🇮🇳' },
            'es': { name: 'Spanish', flag: '🇪🇸' },
            'fr': { name: 'French', flag: '🇫🇷' },
            'de': { name: 'German', flag: '🇩🇪' },
            'ja': { name: 'Japanese', flag: '🇯🇵' },
            'ko': { name: 'Korean', flag: '🇰🇷' },
            'pt': { name: 'Portuguese', flag: '🇵🇹' },
            'it': { name: 'Italian', flag: '🇮🇹' },
            'ru': { name: 'Russian', flag: '🇷🇺' }
        };

        // ===========================================
        // STATE MANAGEMENT
        // ===========================================
        let userProfile = {
            user_id: Date.now().toString(),
            name: 'User',
            age: 25,
            safe_mode: true,
            language: ['en'],
            mood: 'happy',
            region: 'US',
            watchlist: [],
            history: [],
            liked_movies: [],
            disliked_movies: [],
            profile_pic: null,
            last_mood_update: null,
            timestamp: new Date()
        };

        let watchlist = [];
        let genreMap = {};
        let languages = {};
        let trendingPage = 1;
        let topRatedPage = 1;
        // Caching for optimization
        let CACHE_TTL_MS = 60000; // 60 seconds
        let searchResultCache = new Map();
        let suggestionCache = new Map();
        let tmdbPosterCache = new Map(); // id -> poster_path/backdrop/absolute


        // ===========================================
        // INITIALIZATION
        // ===========================================
        lucide.createIcons();
        initializeApp();

        function initializeApp() {
            loadUserProfile();
            detectUserLocation();
            getGenres();
            getLanguages();
            setupEventListeners();
            setupLanguageSelector();
            loadInitialData();
            checkMoodUpdate();
            updateUI();
        }

        // ===========================================
        // USER PROFILE MANAGEMENT
        // ===========================================
        function loadUserProfile() {
            const saved = localStorage.getItem('movieExplorerProfile');
            if (saved) {
                userProfile = { ...userProfile, ...JSON.parse(saved) };
            }
            watchlist = userProfile.watchlist || [];
        }

        function saveUserProfile() {
            userProfile.timestamp = new Date();
            localStorage.setItem('movieExplorerProfile', JSON.stringify(userProfile));
        }

        async function detectUserLocation() {
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const language = navigator.language || navigator.userLanguage;
                
                if (!localStorage.getItem('movieExplorerProfile')) {
                    userProfile.language = [language.split('-')[0]];
                    userProfile.region = language.split('-')[1] || 'US';
                }
            } catch (error) {
                console.log('Could not detect location, using defaults');
            }
        }

        function updateUI() {
            document.getElementById('profile-pic').src = userProfile.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.name)}&background=667eea&color=fff`;
            updateWatchlistCount();
            populateProfileForm();
        }

        function populateProfileForm() {
            document.getElementById('profile-name-input').value = userProfile.name;
            document.getElementById('profile-age-input').value = userProfile.age;
            document.getElementById('profile-region-input').value = userProfile.region;
            document.getElementById('safe-mode-input').checked = userProfile.safe_mode;
            document.getElementById('profile-pic-large').src = userProfile.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.name)}&background=667eea&color=fff`;
            
            // Set languages
            const langSelect = document.getElementById('profile-languages-input');
            Array.from(langSelect.options).forEach(option => {
                option.selected = userProfile.language.includes(option.value);
            });
            
            // Update custom language options
            document.querySelectorAll('.language-option').forEach(option => {
                if (userProfile.language.includes(option.dataset.lang)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            updateLanguageBadges();
            updateMoodSelection();
        }

        // ===========================================
        // TOAST NOTIFICATIONS
        // ===========================================
        function showToast(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: 'check-circle',
                warning: 'alert-triangle',
                error: 'x-circle'
            };

            toast.innerHTML = `
                <i data-lucide="${iconMap[type] || 'info'}" class="w-5 h-5 flex-shrink-0"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.parentNode?.removeChild(toast), 300);
            }, 3000);
        }

        // ===========================================
        // LANGUAGE MANAGEMENT
        // ===========================================
        function updateLanguageBadges() {
            const langSelect = document.getElementById('profile-languages-input');
            const badgesContainer = document.getElementById('language-badges');
            
            if (!langSelect || !badgesContainer) return;

            const selectedLanguages = Array.from(langSelect.selectedOptions).map(option => option.value);
            
            badgesContainer.innerHTML = selectedLanguages.map(langCode => {
                const langInfo = LANGUAGE_MAP[langCode] || { name: langCode, flag: '' };
                return `
                    <div class="language-badge">
                        <span class="mr-1">${langInfo.flag}</span>
                        ${langInfo.name}
                        <span class="remove-btn" onclick="removeLanguage('${langCode}')" title="Remove ${langInfo.name}">
                            ×
                        </span>
                    </div>
                `;
            }).join('');
        }

        function removeLanguage(langCode) {
            const langSelect = document.getElementById('profile-languages-input');
            const languageOption = document.querySelector(`[data-lang="${langCode}"]`);
            const option = langSelect.querySelector(`option[value="${langCode}"]`);
            
            if (option) {
                option.selected = false;
                languageOption?.classList.remove('selected');
                updateLanguageBadges();
            }
        }

        function setupLanguageSelector() {
            const languageOptions = document.querySelectorAll('.language-option');
            const langSelect = document.getElementById('profile-languages-input');
            
            languageOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const langCode = option.dataset.lang;
                    const selectOption = langSelect.querySelector(`option[value="${langCode}"]`);
                    
                    if (selectOption) {
                        if (option.classList.contains('selected')) {
                            option.classList.remove('selected');
                            selectOption.selected = false;
                        } else {
                            option.classList.add('selected');
                            selectOption.selected = true;
                        }
                        updateLanguageBadges();
                        
                        // Update user profile language preferences
                        userProfile.language = Array.from(langSelect.selectedOptions).map(opt => opt.value);
                        saveUserProfile();
                        
                        // Refresh recommendations based on new language preferences
                        loadPersonalizedRecommendations();
                    }
                });
            });
        }

        // ===========================================
        // MOOD MANAGEMENT
        // ===========================================
        function updateMoodSelection() {
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.mood === userProfile.mood) {
                    btn.classList.add('selected');
                }
            });
        }

        function checkMoodUpdate() {
            const lastUpdate = userProfile.last_mood_update;
            const oneHour = 60 * 60 * 1000;
            
            if (!lastUpdate || (Date.now() - new Date(lastUpdate).getTime()) > oneHour) {
                setTimeout(() => {
                    document.getElementById('mood-popup').classList.remove('hidden');
                }, 2000);
            }
        }

        // ===========================================
        // API FUNCTIONS
        // ===========================================
        function buildApiUrl(endpoint, page = 1, additionalParams = {}) {
            const baseUrl = 'http://127.0.0.1:8000';
            const params = new URLSearchParams();
            
            // Add common filters
            if (userProfile.safe_mode) {
                params.set('safe_mode', 'true');
            }
            
            if (userProfile.language && userProfile.language.length > 0) {
                params.set('languages', userProfile.language.join(','));
            }
            
            params.set('limit', '10');
            
            // Add any additional parameters
            Object.entries(additionalParams).forEach(([key, value]) => {
                if (value !== null && value !== undefined && value !== '') {
                    params.set(key, value);
                }
            });
            
            return `${baseUrl}/${endpoint}?${params.toString()}`;
        }

        async function fetchMovies(endpoint, page = 1, filters = {}) {
            try {
                let apiUrl;
                
                if (endpoint === 'trending/movie/day') {
                    apiUrl = buildApiUrl('trending', page, filters);
                } else if (endpoint === 'movie/top_rated') {
                    apiUrl = buildApiUrl('top-rated', page, filters);
                } else {
                    // Fallback to TMDB for other endpoints
                    apiUrl = `${TMDB_BASE_URL}/${endpoint}?api_key=${TMDB_API_KEY}&language=en-US&page=${page}&region=${userProfile.region}`;
                }
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                return Array.isArray(data) ? data : data.results || [];
            } catch (error) {
                console.error('Error fetching movies:', error);
                return [];
            }
        }

        async function fetchPersonalizedRecommendations() {
            try {
                const response = await fetch('http://127.0.0.1:8000/recommendations/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mood: userProfile.mood,
                        language: userProfile.language || ['en'],
                        liked_movies: userProfile.liked_movies || [],
                        disliked_movies: userProfile.disliked_movies || [],
                        watchlist: userProfile.watchlist.map(m => m.id || m) || []
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return Array.isArray(data) ? data : [];
                }
                return [];
            } catch (error) {
                console.error('Error fetching personalized recommendations:', error);
                return [];
            }
        }

        function getGenres() {
            // Use predefined genre list that matches our LightFM model
            const predefinedGenres = [
                'Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Documentary', 
                'Drama', 'Family', 'Fantasy', 'History', 'Horror', 'Music', 
                'Mystery', 'Romance', 'Science Fiction', 'TV Movie', 'Thriller', 'War', 'Western'
            ];
            
            // Create a simple mapping for filtering
            genreMap = {};
            predefinedGenres.forEach((genre, index) => {
                genreMap[genre.toLowerCase()] = genre;
            });
            
            populateGenreFilter();
        }

        async function getLanguages() {
            try {
                const response = await fetch(`${TMDB_BASE_URL}/configuration/languages?api_key=${TMDB_API_KEY}`);
                const data = await response.json();
                languages = data.reduce((acc, lang) => {
                    acc[lang.iso_639_1] = lang.english_name;
                    return acc;
                }, {});
                populateLanguageFilter();
            } catch (error) {
                console.error('Error fetching languages:', error);
            }
        }

        async function getTrailer(movieId) {
            try {
                const response = await fetch(`${TMDB_BASE_URL}/movie/${movieId}/videos?api_key=${TMDB_API_KEY}`);
                const data = await response.json();
                const trailer = data.results.find(video => video.site === "YouTube" && video.type === "Trailer");
                return trailer ? `${YOUTUBE_BASE_URL}${trailer.key}` : null;
            } catch (error) {
                console.error('Error fetching trailer:', error);
                return null;
            }
        }

        async function getRecommendations(movieId) {
            try {
                const params = new URLSearchParams();
                params.set('movie_id', movieId);
                
                // Add user filters
                if (userProfile.safe_mode) {
                    params.set('safe_mode', 'true');
                }
                
                if (userProfile.language && userProfile.language.length > 0) {
                    params.set('languages', userProfile.language.join(','));
                }
                
                params.set('limit', '10');
                
                const response = await fetch(`http://127.0.0.1:8000/recommendations?${params.toString()}`);
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Error fetching recommendations:', error);
                return [];
            }
        }

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        function getPosterUrl(path) {
            return path ? `${IMAGE_BASE_URL}${path}` : FALLBACK_POSTER_URL;
        }

        function getMoviePoster(movie) {
            if (!movie || typeof movie !== 'object') return FALLBACK_POSTER_URL;
            const candidates = [
                movie.poster_path,
                movie.poster,
                movie.posterUrl,
                movie.poster_url,
                movie.image_url,
                movie.image,
                movie.poster_path_hq,
                movie.backdrop_path
            ];
            for (const candidate of candidates) {
                if (!candidate) continue;
                const raw = String(candidate).trim();
                if (!raw || raw === 'null' || raw === 'None' || raw === 'undefined' || raw.toLowerCase() === 'nan') continue;
                if (raw.startsWith('data:image')) return raw;
                if (raw.startsWith('http')) return raw;
                if (raw.startsWith('//')) return `https:${raw}`;
                if (raw.includes('image.tmdb.org')) return raw.startsWith('http') ? raw : `https:${raw}`;
                if (raw.startsWith('/')) return `${IMAGE_BASE_URL}${raw}`;
                // As a last resort, assume it's a path relative to TMDB poster root
                return `${IMAGE_BASE_URL}/${raw.replace(/^\/+/, '')}`;
            }
            return FALLBACK_POSTER_URL;
        }

        function movieNeedsPoster(movie) {
            if (!movie) return true;
            const fields = [
                movie.poster_path,
                movie.poster,
                movie.posterUrl,
                movie.poster_url,
                movie.image_url,
                movie.image,
                movie.poster_path_hq,
                movie.backdrop_path
            ];
            return !fields.some(v => v && String(v).trim() && String(v).trim() !== 'null');
        }

        async function enrichMoviePosters(movies) {
            try {
                const toFix = movies.filter(m => movieNeedsPoster(m) && m && m.id);
                if (toFix.length === 0) return;

                // Limit network load
                const limited = toFix.slice(0, 6);
                const fetches = limited.map(async (m) => {
                    if (tmdbPosterCache.has(m.id)) {
                        const cached = tmdbPosterCache.get(m.id);
                        if (cached) {
                            if (!m.poster_path && cached.poster_path) m.poster_path = cached.poster_path;
                            if (!m.backdrop_path && cached.backdrop_path) m.backdrop_path = cached.backdrop_path;
                        }
                        return;
                    }
                    try {
                        const resp = await fetch(`${TMDB_BASE_URL}/movie/${m.id}?api_key=${TMDB_API_KEY}&language=en-US`);
                        if (!resp.ok) return;
                        const data = await resp.json();
                        tmdbPosterCache.set(m.id, { poster_path: data.poster_path, backdrop_path: data.backdrop_path });
                        if (!m.poster_path && data.poster_path) m.poster_path = data.poster_path;
                        if (!m.backdrop_path && data.backdrop_path) m.backdrop_path = data.backdrop_path;
                        if (!m.title && data.title) m.title = data.title;
                    } catch (e) {
                        // ignore
                    }
                });
                await Promise.all(fetches);
            } catch (e) {
                // ignore enrichment errors
            }
        }

        function populateGenreFilter() { /* filters removed */ }

        function populateLanguageFilter() { /* filters removed */ }

        // ===========================================
        // MOVIE CARD FUNCTIONS
        // ===========================================
                 function createMovieCard(movie, showTrendingNumber = false, trendingIndex = 0) {
             const isInWatchlist = watchlist.some(item => item.id === movie.id);
             const genres = movie.genre_ids ? movie.genre_ids.map(id => genreMap[id]).filter(Boolean).slice(0, 2) : [];
             const shouldEagerLoad = trendingIndex < 4; // eagerly load first few posters in each row
             
              return `
                 <div class="movie-card bg-gray-800/30 rounded-2xl p-4 hover:bg-gray-800/50 transition-all group relative flex flex-col h-full">
                     ${showTrendingNumber ? `<div class=\"trending-number\">${trendingIndex + 1}</div>` : ''}
                     <div class="poster-container aspect-[2/3] w-full rounded-xl overflow-hidden mb-4 relative">
                         ${movie.adult ? `<div class=\"adult-badge\">18+</div>` : ''}
                         <img src="${getMoviePoster(movie)}" alt="${movie.title}" ${shouldEagerLoad ? 'loading="eager"' : 'loading="lazy"'} onerror="this.onerror=null;this.src='https://dummyimage.com/500x750/1f2937/9ca3af&text=No+Poster';" data-poster-for="${movie.id}"
                             class="w-full h-full object-cover rounded-xl transition-transform group-hover:scale-110 ${movie.adult ? 'poster-blur' : ''}" />
                         <button class="poster-details-btn" onclick="showMovieDetail(${movie.id})">
                             <i data-lucide="info" class="w-5 h-5"></i>
                         </button>
                     </div>
                     <h3 class="font-semibold text-sm mb-2 line-clamp-1 cursor-pointer" title="${movie.title}" onclick="showMovieDetail(${movie.id})">${movie.title}</h3>
                     <div class="flex items-center justify-between text-xs text-gray-400 mb-3">
                         <span class="flex items-center">
                             <i data-lucide="star" class="w-3 h-3 mr-1 text-yellow-400"></i>
                             ${movie.vote_average && movie.vote_average > 0 ? movie.vote_average.toFixed(1) : 'N/A'}
                         </span>
                         <span>${movie.release_date ? new Date(movie.release_date).getFullYear() : 'TBA'}</span>
                     </div>
                     ${genres.length > 0 ? `<div class=\"flex flex-wrap gap-1 mb-3\">
                         ${genres.map(genre => `<span class=\"px-2 py-1 bg-purple-500/20 text-purple-300 text-xs rounded-full\">${genre}</span>`).join('')}
                     </div>` : ''}
                     <div class="space-y-2 mt-auto">
                         <button data-movie-id="${movie.id}" onclick="toggleWatchlist(${JSON.stringify(movie).replace(/"/g, '&quot;')})" 
                                 class="watchlist-btn w-full py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center ${
                                     isInWatchlist 
                                         ? 'bg-green-600 hover:bg-green-700 text-white' 
                                         : 'bg-purple-600 hover:bg-purple-700 text-white'
                                 }">
                             <i data-lucide="${isInWatchlist ? 'check' : 'plus'}" class="w-4 h-4 mr-2"></i>
                             ${isInWatchlist ? 'In Watchlist' : 'Add to Watchlist'}
                         </button>
                     </div>
                 </div>
             `;
         }

        // ===========================================
        // MOVIE DETAIL FUNCTIONS
        // ===========================================
        async function showMovieDetail(movieId) {
            const modal = document.getElementById('movie-modal');
            const content = document.getElementById('movie-detail-content');

            try {
                addToHistory(movieId);

                const response = await fetch(`${TMDB_BASE_URL}/movie/${movieId}?api_key=${TMDB_API_KEY}&language=en-US`);
                const movie = await response.json();
                const trailerUrl = await getTrailer(movieId);

                const isLiked = userProfile.liked_movies.includes(movieId);
                const isDisliked = userProfile.disliked_movies.includes(movieId);
                const isInWatchlist = watchlist.some(item => item.id === movie.id);

                content.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold line-clamp-2">${movie.title}</h2>
                        <button onclick="closeMovieModal()" class="p-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="grid md:grid-cols-4 gap-6">
                        <div class="md:col-span-1">
                            ${movie.adult ? `<div class=\"adult-badge\">18+</div>` : ''}
                            <img src="${getMoviePoster(movie)}" alt="${movie.title}" class="w-full rounded-xl shadow-lg mb-4 ${movie.adult ? 'poster-blur' : ''}">
                        </div>
                        <div class="md:col-span-3 flex flex-col">
                            <div class="flex items-center gap-4 mb-4">
                                <span class="flex items-center text-yellow-400">
                                    <i data-lucide="star" class="w-4 h-4 mr-1"></i>
                                    ${movie.vote_average && movie.vote_average > 0 ? movie.vote_average.toFixed(1) : 'N/A'}
                                </span>
                                <span class="text-gray-400">${movie.release_date ?? ''}</span>
                                <span class="text-gray-400">${movie.runtime ? movie.runtime + ' min' : 'N/A'}</span>
                            </div>
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${movie.genres.map(genre => `<span class="px-3 py-1 bg-purple-500/20 text-purple-300 text-sm rounded-full">${genre.name}</span>`).join('')}
                            </div>
                            <div class="mb-4">
                                <strong class="text-gray-300">Languages:</strong>
                                <span class="text-gray-400 ml-2">${movie.spoken_languages.map(lang => lang.english_name).join(', ')}</span>
                            </div>
                            <p class="text-gray-300 mb-6">${movie.overview || 'No overview available.'}</p>
                            <div class="flex flex-wrap gap-3 mb-6">
                                <button data-movie-id="${movie.id}" onclick="toggleWatchlist(${JSON.stringify(movie).replace(/"/g, '&quot;')})" 
                                        class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-white flex items-center transition-colors">
                                    <i data-lucide="bookmark" class="w-4 h-4 mr-2"></i>
                                    ${isInWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist'}
                                </button>
                                ${trailerUrl ? `
                                <button onclick="showTrailerModal('${trailerUrl.replace('watch?v=', 'embed/')}')" 
                                        class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-white flex items-center transition-colors">
                                    <i data-lucide="play-circle" class="w-4 h-4 mr-2"></i>
                                    Watch Trailer
                                </button>
                                ` : ''}
                                <button onclick="rateMovie(${movieId}, true); updateRatingButtons(${movieId})" 
                                        id="like-btn-${movieId}" class="rating-btn px-4 py-2 rounded-lg flex items-center transition-colors ${isLiked ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}">
                                    <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                                </button>
                                <button onclick="rateMovie(${movieId}, false); updateRatingButtons(${movieId})" 
                                        id="dislike-btn-${movieId}" class="rating-btn px-4 py-2 rounded-lg flex items-center transition-colors ${isDisliked ? 'bg-red-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}">
                                    <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="recommendations-section" class="mt-10">
                        <div class="section-navigation">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i data-lucide="target" class="w-5 h-5 mr-2 text-green-400"></i>
                                More Like This
                            </h3>
                            <div class="nav-controls">
                                <button class="nav-btn" onclick="scrollSection('recommendations-list', 'left')" title="Scroll Left (←)">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                                <button class="nav-btn" onclick="scrollSection('recommendations-list', 'right')" title="Scroll Right (→)">
                                    <i data-lucide="chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div id="recommendations-loading" class="flex justify-center py-8">
                            <svg class="animate-spin h-8 w-8 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                        </div>
                        <div class="horizontal-scroll scrollbar-hide pb-2 gap-4" id="recommendations-list-container">
                            <div id="recommendations-list" class="flex gap-4"></div>
                            <div class="scroll-indicator">
                                <div class="scroll-progress" id="recommendations-list-progress"></div>
                            </div>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
                lucide.createIcons();

                // Fetch recommendations
                const recommendations = await getRecommendations(movieId);
                const recList = document.getElementById('recommendations-list');
                const recLoading = document.getElementById('recommendations-loading');
                recLoading.style.display = 'none';

                if (recommendations.length > 0) {
                    recList.innerHTML = recommendations.slice(0, 12).map(rec => `
                        <div class="flex-shrink-0 w-32 cursor-pointer hover:bg-gray-800/30 p-2 rounded-lg transition-colors" onclick="showMovieDetail(${rec.id})">
                            <img src="${getMoviePoster(rec)}" alt="${rec.title}" 
                                 class="w-full h-44 object-cover rounded mb-2">
                            <div class="min-w-0">
                                <p class="text-xs font-medium text-white truncate">${rec.title}</p>
                                <p class="text-xs text-gray-400">${rec.release_date ? new Date(rec.release_date).getFullYear() : 'TBA'}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    // Set up horizontal scrolling for the recommendations
                    const scrollContainer = recList.closest('.horizontal-scroll');
                    if (scrollContainer) {
                        setupHorizontalScroll();
                        updateNavigationButtons(scrollContainer);
                    }
                } else {
                    recList.innerHTML = `<p class="text-gray-400 text-center w-full">No recommendations found.</p>`;
                }
                lucide.createIcons();
            } catch (error) {
                console.error('Error fetching movie details:', error);
            }
        }

        function closeMovieModal() {
            document.getElementById('movie-modal').classList.add('hidden');
        }

        function closeTrailerModal() {
            document.getElementById('trailer-modal').classList.add('hidden');
            document.getElementById('trailer-iframe-container').innerHTML = '';
        }

        function showTrailerModal(embedUrl) {
            const modal = document.getElementById('trailer-modal');
            const container = document.getElementById('trailer-iframe-container');
            container.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen class="w-full h-full rounded-lg"></iframe>`;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        // ===========================================
        // WATCHLIST FUNCTIONS
        // ===========================================
        function toggleWatchlist(movie) {
            const index = watchlist.findIndex(item => item.id === movie.id);
            let message = '';
            if (index === -1) {
                watchlist.push(movie);
                message = 'Added to Watchlist!';
            } else {
                watchlist.splice(index, 1);
                message = 'Removed from Watchlist!';
            }
            // Keep userProfile.watchlist in sync with local watchlist
            userProfile.watchlist = [...watchlist];
            saveUserProfile();
            updateWatchlistCount();
            updateWatchlistModal();
            updateWatchlistButton(movie);
            showToast(message, 'success');
            
            // Refresh recommendations after watchlist change
            loadPersonalizedRecommendations();
        }

        function updateWatchlistCount() {
            const countEl = document.getElementById('watchlist-count');
            if (watchlist.length > 0) {
                countEl.textContent = watchlist.length;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }

        function updateWatchlistButton(movie) {
            const isInWatchlist = watchlist.some(item => item.id === movie.id);
            const buttons = document.querySelectorAll(`[data-movie-id="${movie.id}"]`);
            buttons.forEach(button => {
                if (button.classList.contains('watchlist-btn')) {
                    button.innerHTML = `
                        <i data-lucide="${isInWatchlist ? 'check' : 'plus'}" class="w-4 h-4 mr-2"></i>
                        ${isInWatchlist ? 'In Watchlist' : 'Add to Watchlist'}
                    `;
                    button.className = `watchlist-btn w-full py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center ${
                        isInWatchlist 
                            ? 'bg-green-600 hover:bg-green-700 text-white' 
                            : 'bg-purple-600 hover:bg-purple-700 text-white'
                    }`;
                } else {
                    // Update modal buttons that don't have watchlist-btn class
                    button.innerHTML = `
                        <i data-lucide="bookmark" class="w-4 h-4 mr-2"></i>
                        ${isInWatchlist ? 'Remove from Watchlist' : 'Add to Watchlist'}
                    `;
                    button.className = `${
                        isInWatchlist 
                            ? 'bg-red-600 hover:bg-red-700' 
                            : 'bg-purple-600 hover:bg-purple-700'
                    } px-4 py-2 rounded-lg text-white flex items-center transition-colors`;
                }
            });
            lucide.createIcons();
        }

        function updateWatchlistModal() {
            const content = document.getElementById('watchlist-content');
            if (watchlist.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12 col-span-full">
                        <i data-lucide="bookmark" class="w-16 h-16 mx-auto text-gray-600 mb-4"></i>
                        <p class="text-gray-400">Your watchlist is empty</p>
                    </div>
                `;
            } else {
                content.innerHTML = watchlist.map(movie => `
                    <div class="bg-gray-800/30 rounded-2xl p-4">
                        <img src="${getPosterUrl(movie.poster_path)}" alt="${movie.title}" 
                             class="w-full object-cover rounded-xl mb-3 cursor-pointer" onclick="showMovieDetail(${movie.id})">
                        <h3 class="font-semibold text-sm mb-2 line-clamp-1">${movie.title}</h3>
                        <button onclick="toggleWatchlist(${JSON.stringify(movie).replace(/"/g, '&quot;')})" 
                                class="w-full bg-red-600 hover:bg-red-700 py-2 rounded-lg text-sm flex items-center justify-center transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                            Remove
                        </button>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        // ===========================================
        // DISPLAY & SEARCH FUNCTIONS
        // ===========================================
         async function displayMovies(movies, containerId, showTrendingNumbers = false) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Apply Safe Mode: hide adult content entirely when enabled
            const filtered = Array.isArray(movies)
                ? movies.filter(m => !(userProfile.safe_mode && (m.adult === true)))
                : [];

            // Build skeletons first to avoid flicker
            const skeletonCount = 10;
            const skeletons = Array.from({ length: skeletonCount }).map(() => `
                <div class="movie-card skeleton-card">
                    <div class="bg-gray-800/30 rounded-2xl p-4">
                        <div class="skeleton-animate rounded-xl h-64 mb-4"></div>
                        <div class="skeleton-animate h-4 rounded mb-2"></div>
                        <div class="skeleton-animate h-3 rounded mb-2 w-2/3"></div>
                        <div class="skeleton-animate h-8 rounded mt-4"></div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = skeletons;

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center min-w-full">No movies found.</p>';
                return;
            }

            // Optionally enrich missing posters via TMDB for a few items
            try { await enrichMoviePosters(filtered.slice(0, 10)); } catch (e) {}

            // Defer DOM replacement to next frame to reduce layout thrash
            const visibleMovies = filtered.slice(0, 10);
            const movieCards = visibleMovies.map((movie, index) => createMovieCard(movie, showTrendingNumbers, index)).join('');

            requestAnimationFrame(() => {
                container.innerHTML = movieCards;
                lucide.createIcons();

                const scrollContainer = container.closest('.horizontal-scroll');
                if (scrollContainer) {
                    setupHorizontalScroll();
                    updateNavigationButtons(scrollContainer);
                }
            });
        }

        // ===========================================
        // SEARCH SUGGESTIONS FUNCTIONS
        // ===========================================
        let searchTimeout;
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;
        let suggestionsController = null;
        let searchController = null;
        let recsController = null;
        let recsDebounceTimeout = null;

        async function getSearchSuggestions(query) {
            if (!query.trim() || query.length < 2) {
                hideSuggestions();
                return;
            }

            try {
                // Cache lookup
                const cacheKey = `${query}|${(userProfile.language||[]).join(',')}|${userProfile.safe_mode?'1':'0'}`;
                const cached = suggestionCache.get(cacheKey);
                if (cached && (Date.now() - cached.time) < CACHE_TTL_MS) {
                    currentSuggestions = cached.results;
                    displaySuggestions(cached.results);
                    return;
                }
                // Abort any in-flight suggestions request
                if (suggestionsController) {
                    suggestionsController.abort();
                }
                suggestionsController = new AbortController();

                const params = new URLSearchParams();
                params.set('query', query);
                params.set('limit', '8'); // Limit suggestions to 8 for better UX
                
                if (userProfile.safe_mode) {
                    params.set('safe_mode', 'true');
                }
                
                if (userProfile.language && userProfile.language.length > 0) {
                    params.set('languages', userProfile.language.join(','));
                }
                
                const response = await fetch(`http://127.0.0.1:8000/search?${params.toString()}`, { signal: suggestionsController.signal });
                const results = await response.json();
                
                if (Array.isArray(results)) {
                    currentSuggestions = results;
                    displaySuggestions(results);
                    suggestionCache.set(cacheKey, { results, time: Date.now() });
                } else {
                    currentSuggestions = [];
                    displaySuggestions([]);
                }
            } catch (error) {
                console.error('Error fetching search suggestions:', error);
                currentSuggestions = [];
                displaySuggestions([]);
            }
        }

        function displaySuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('search-suggestions');
            const content = document.getElementById('suggestions-content');
            
            if (!suggestions || suggestions.length === 0) {
                content.innerHTML = `
                    <div class="no-suggestions">
                        <i data-lucide="search" class="w-5 h-5 mx-auto mb-2 text-gray-500"></i>
                        <p>No movies found</p>
                    </div>
                `;
                suggestionsContainer.classList.remove('hidden');
                return;
            }

             content.innerHTML = suggestions.map((movie, index) => `
                <div class="search-suggestion-item" data-index="${index}" onclick="selectSuggestion(${index})">
                    <img src="${getPosterUrl(movie.poster_path)}" alt="${movie.title}" class="suggestion-poster" loading="lazy">
                    <div class="suggestion-info">
                        <div class="suggestion-title">${movie.title}</div>
                        <div class="suggestion-meta">
                            ${movie.release_date ? `<span class="suggestion-year">${new Date(movie.release_date).getFullYear()}</span>` : ''}
                            ${movie.vote_average && movie.vote_average > 0 ? `
                                <span class="suggestion-rating">
                                    <i data-lucide="star" class="w-3 h-3"></i>
                                    ${movie.vote_average.toFixed(1)}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            suggestionsContainer.classList.remove('hidden');
            lucide.createIcons();
            selectedSuggestionIndex = -1;
        }

        function selectSuggestion(index) {
            if (index >= 0 && index < currentSuggestions.length) {
                const movie = currentSuggestions[index];
                document.getElementById('search-input').value = movie.title;
                hideSuggestions();
                
                // Trigger search with the selected movie title
                searchMovies(movie.title);
            }
        }

        function hideSuggestions() {
            const suggestionsContainer = document.getElementById('search-suggestions');
            suggestionsContainer.classList.add('hidden');
            selectedSuggestionIndex = -1;
        }

        function handleSuggestionNavigation(direction) {
            if (currentSuggestions.length === 0) return;
            
            const items = document.querySelectorAll('.search-suggestion-item');
            if (items.length === 0) return;

            // Remove previous selection
            if (selectedSuggestionIndex >= 0 && items[selectedSuggestionIndex]) {
                items[selectedSuggestionIndex].classList.remove('selected');
            }

            if (direction === 'down') {
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
            } else if (direction === 'up') {
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
            }

            // Add new selection
            if (selectedSuggestionIndex >= 0 && items[selectedSuggestionIndex]) {
                items[selectedSuggestionIndex].classList.add('selected');
                items[selectedSuggestionIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function handleSuggestionEnter() {
            if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < currentSuggestions.length) {
                selectSuggestion(selectedSuggestionIndex);
            } else {
                // If no suggestion is selected, perform regular search
                const query = document.getElementById('search-input').value.trim();
                if (query) {
                    searchMovies(query);
                }
            }
        }

        async function searchMovies(query) {
            if (!query.trim()) return;

            try {
                document.getElementById('loading-spinner').classList.remove('hidden');
                hideSuggestions(); // Hide suggestions when performing search

                // Abort any in-flight search and recommendation requests
                if (searchController) {
                    searchController.abort();
                }
                if (recsController) {
                    recsController.abort();
                }
                searchController = new AbortController();

                const genreFilter = '';
                const languageFilter = '';
                
                // Build search URL with filters
                const params = new URLSearchParams();
                params.set('query', query);
                
                if (userProfile.safe_mode) {
                    params.set('safe_mode', 'true');
                }
                
                if (userProfile.language && userProfile.language.length > 0) {
                    params.set('languages', userProfile.language.join(','));
                }
                
                // filters removed in UI
                
                params.set('limit', '10');
                
                // Cache lookup
                const cacheKey = `${params.toString()}`;
                const cached = searchResultCache.get(cacheKey);
                let results;
                if (cached && (Date.now() - cached.time) < CACHE_TTL_MS) {
                    results = cached.results;
                } else {
                    const response = await fetch(`http://127.0.0.1:8000/search?${params.toString()}`, { signal: searchController.signal, cache: 'no-store' });
                    results = await response.json();
                    searchResultCache.set(cacheKey, { results, time: Date.now() });
                }

                const searchSection = document.getElementById('search-results');
                const recommendationsSection = document.getElementById('recommendations');

                if (results.length > 0) {
                    addToHistory(results[0].id);
                    
                    searchSection.classList.remove('hidden');
                    await displayMovies(results, 'search-movies');

                    // Fetch recommendations for first result, abortable
                    if (recsController) {
                        recsController.abort();
                    }
                    recsController = new AbortController();
                    const recParams = new URLSearchParams();
                    recParams.set('movie_id', results[0].id);
                    if (userProfile.safe_mode) recParams.set('safe_mode', 'true');
                    if (userProfile.language && userProfile.language.length > 0) {
                        recParams.set('languages', userProfile.language.join(','));
                    }
                    recParams.set('limit', '10');
                    const recResponse = await fetch(`http://127.0.0.1:8000/recommendations?${recParams.toString()}`, { signal: recsController.signal, cache: 'no-store' });
                    const recommendations = await recResponse.json();
                    if (recommendations.length > 0) {
                        recommendationsSection.classList.remove('hidden');
                        await displayMovies(recommendations, 'recommendation-movies');
                    } else {
                        recommendationsSection.classList.add('hidden');
                    }
                } else {
                    searchSection.classList.add('hidden');
                    recommendationsSection.classList.add('hidden');
                    document.getElementById('search-input').focus();
                }
            } catch (error) {
                console.error('Error searching movies:', error);
            } finally {
                document.getElementById('loading-spinner').classList.add('hidden');
            }
        }

        async function loadInitialData() {
            const trendingPromise = fetchMovies('trending/movie/day', trendingPage);
            const topRatedPromise = fetchMovies('movie/top_rated', topRatedPage);

            const [trending, topRated] = await Promise.all([trendingPromise, topRatedPromise]);

            displayMovies(trending, 'trending-movies', true);
            displayMovies(topRated, 'toprated-movies');

            // Load personalized recommendations (non-blocking)
            loadPersonalizedRecommendations();
        }

        async function loadPersonalizedRecommendations() {
            // Debounce and abort to prevent blocking searches
            if (recsDebounceTimeout) clearTimeout(recsDebounceTimeout);
            return new Promise((resolve) => {
                recsDebounceTimeout = setTimeout(async () => {
                    if (recsController) recsController.abort();
                    recsController = new AbortController();

                    const container = document.getElementById('user-recommendation-movies');
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-4 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                            <p>Loading recommendations...</p>
                        </div>
                    `;

                    try {
                        const recommendedMovies = await fetchPersonalizedRecommendations();
                        if (recommendedMovies && recommendedMovies.length > 0) {
                            container.innerHTML = '';
                            await displayMovies(recommendedMovies, 'user-recommendation-movies');
                        } else {
                            container.innerHTML = `
                                <div class="text-center py-12 text-gray-400">
                                    <i data-lucide="heart" class="w-16 h-16 mx-auto mb-4"></i>
                                    <p>Watch more movies to get personalized recommendations</p>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                    } catch (error) {
                        if (error?.name === 'AbortError') return resolve();
                        console.error('Error loading personalized recommendations:', error);
                        container.innerHTML = `
                            <div class="text-center py-12 text-red-500">
                                <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto mb-4"></i>
                                <p>Failed to load personalized recommendations. Try again later.</p>
                            </div>
                        `;
                        lucide.createIcons();
                    } finally {
                        resolve();
                    }
                }, 400);
            });
        }




        // ===========================================
        // PROFILE & RATING FUNCTIONS
        // ===========================================
        async function saveProfile() {
            const name = document.getElementById('profile-name-input').value.trim();
            const age = parseInt(document.getElementById('profile-age-input').value);
            const region = document.getElementById('profile-region-input').value;
            const safeMode = document.getElementById('safe-mode-input').checked;
            const languages = Array.from(document.getElementById('profile-languages-input').selectedOptions).map(option => option.value);

            if (!age || isNaN(age) || age < 13 || age > 100) {
                showToast('Please enter a valid age between 13 and 100.', 'warning');
                return;
            }

            if (age < 18 && !safeMode) {
                document.getElementById('safe-mode-input').checked = true;
                showToast('Safe Mode is required for users under 18 years old.', 'warning');
                return;
            }

            if (age >= 18 && !safeMode) {
                showToast('Safe Mode disabled. Adult content may be shown.', 'warning');
            }

            userProfile.name = name || 'User';
            userProfile.age = age || 25;
            userProfile.region = region;
            userProfile.safe_mode = safeMode;
            userProfile.language = languages.length > 0 ? languages : ['en'];

            saveUserProfile();
            updateUI();
            document.getElementById('profile-modal').classList.add('hidden');
            showToast('Profile saved successfully!', 'success');
            
            // Reload personalized recommendations with updated profile
            await loadPersonalizedRecommendations();
        }

        function handleProfilePicUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showToast('Please select a valid image file.', 'warning');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    userProfile.profile_pic = dataUrl;
                    document.getElementById('profile-pic').src = dataUrl;
                    document.getElementById('profile-pic-large').src = dataUrl;
                    saveUserProfile();
                };
                reader.readAsDataURL(file);
            }
        }

        function addToHistory(movieId) {
            if (!userProfile.history.includes(movieId)) {
                userProfile.history.unshift(movieId);
                if (userProfile.history.length > 100) {
                    userProfile.history = userProfile.history.slice(0, 100);
                }
                saveUserProfile();
            }
        }

        function rateMovie(movieId, liked) {
            if (liked) {
                if (!userProfile.liked_movies.includes(movieId)) {
                    userProfile.liked_movies.push(movieId);
                }
                userProfile.disliked_movies = userProfile.disliked_movies.filter(id => id !== movieId);
            } else {
                if (!userProfile.disliked_movies.includes(movieId)) {
                    userProfile.disliked_movies.push(movieId);
                }
                userProfile.liked_movies = userProfile.liked_movies.filter(id => id !== movieId);
            }
            saveUserProfile();
            
            // Refresh recommendations after rating change
            loadPersonalizedRecommendations();
        }

        function updateRatingButtons(movieId) {
            const isLiked = userProfile.liked_movies.includes(movieId);
            const isDisliked = userProfile.disliked_movies.includes(movieId);
            
            const likeBtn = document.getElementById(`like-btn-${movieId}`);
            const dislikeBtn = document.getElementById(`dislike-btn-${movieId}`);
            
            if (likeBtn) {
                likeBtn.className = `rating-btn px-4 py-2 rounded-lg flex items-center transition-colors ${isLiked ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}`;
            }
            
            if (dislikeBtn) {
                dislikeBtn.className = `rating-btn px-4 py-2 rounded-lg flex items-center transition-colors ${isDisliked ? 'bg-red-600 text-white' : 'bg-gray-700 hover:bg-gray-600 text-gray-300'}`;
            }
        }

        // ===========================================
        // EVENT LISTENERS
        // ===========================================
        function setupEventListeners() {
            // Search
            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('search-input').value.trim();
                if (query) {
                    searchMovies(query);
                } else {
                    document.getElementById('search-results').classList.add('hidden');
                    document.getElementById('recommendations').classList.add('hidden');
                    document.getElementById('search-input').focus();
                }
            });

            // Search input event listeners for suggestions
            document.getElementById('search-input').addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                // If input is empty, hide suggestions immediately
                if (!query) {
                    hideSuggestions();
                    return;
                }
                
                // Set new timeout for debounced search suggestions
                searchTimeout = setTimeout(() => {
                    getSearchSuggestions(query);
                }, 300); // 300ms delay for better UX
            });

            document.getElementById('search-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSuggestionEnter();
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    handleSuggestionNavigation('down');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    handleSuggestionNavigation('up');
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                    document.getElementById('search-input').blur();
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                const searchContainer = document.getElementById('search-input').closest('.relative');
                if (!searchContainer.contains(e.target)) {
                    hideSuggestions();
                }
            });

            // Focus/blur events for search input
            document.getElementById('search-input').addEventListener('focus', () => {
                const query = document.getElementById('search-input').value.trim();
                if (query.length >= 2) {
                    getSearchSuggestions(query);
                }
            });

            document.getElementById('search-input').addEventListener('blur', () => {
                // Small delay to allow clicking on suggestions
                setTimeout(() => {
                    if (!document.querySelector('.search-suggestion-item:hover')) {
                        hideSuggestions();
                    }
                }, 150);
            });

            // Profile
            document.getElementById('profile-btn').addEventListener('click', () => {
                document.getElementById('profile-modal').classList.remove('hidden');
            });

            document.getElementById('close-profile-modal').addEventListener('click', () => {
                document.getElementById('profile-modal').classList.add('hidden');
            });

            document.getElementById('save-profile').addEventListener('click', saveProfile);
            document.getElementById('profile-pic-input').addEventListener('change', handleProfilePicUpload);
            document.getElementById('profile-languages-input').addEventListener('change', updateLanguageBadges);

            // Mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mood-btn').forEach(b => {
                        b.classList.remove('selected');
                    });
                    btn.classList.add('selected');
                    userProfile.mood = btn.dataset.mood;
                    saveUserProfile();
                    // Refresh recommendations based on new mood
                    loadPersonalizedRecommendations();
                });
            });

                         // Mood popup
             document.querySelectorAll('.mood-popup-btn').forEach(btn => {
                 btn.addEventListener('click', () => {
                     userProfile.mood = btn.dataset.mood;
                     userProfile.last_mood_update = new Date();
                     saveUserProfile();
                     
                     // Update the mood selection in the profile section
                     updateMoodSelection();
                     
                     // Refresh recommendations based on new mood
                     loadPersonalizedRecommendations();
                     
                     document.getElementById('mood-popup').classList.add('hidden');
                 });
             });

            document.getElementById('skip-mood').addEventListener('click', () => {
                userProfile.last_mood_update = new Date();
                saveUserProfile();
                document.getElementById('mood-popup').classList.add('hidden');
            });

            // Watchlist
            document.getElementById('watchlist-btn').addEventListener('click', () => {
                document.getElementById('watchlist-modal').classList.remove('hidden');
                updateWatchlistModal();
            });

            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('watchlist-modal').classList.add('hidden');
            });

            // Modal outside click handlers
            document.getElementById('profile-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('profile-modal').classList.add('hidden');
                }
            });

            document.getElementById('watchlist-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('watchlist-modal').classList.add('hidden');
                }
            });

            document.getElementById('movie-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeMovieModal();
                }
            });

            document.getElementById('mood-popup').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    userProfile.last_mood_update = new Date();
                    saveUserProfile();
                    document.getElementById('mood-popup').classList.add('hidden');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Avoid global shortcuts when user is typing in the search input
                const activeEl = document.activeElement;
                const typingInSearch = activeEl && activeEl.id === 'search-input';
                if (typingInSearch) return;
                if (e.key === 'Escape') {
                    document.getElementById('profile-modal').classList.add('hidden');
                    document.getElementById('watchlist-modal').classList.add('hidden');
                    document.getElementById('movie-modal').classList.add('hidden');
                    document.getElementById('mood-popup').classList.add('hidden');
                    closeTrailerModal();
                }
                
                // Horizontal scrolling with arrow keys
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const activeElement = document.activeElement;
                    const scrollContainer = activeElement.closest('.horizontal-scroll');
                    if (scrollContainer) {
                        e.preventDefault();
                        const scrollAmount = 300;
                        if (e.key === 'ArrowLeft') {
                            scrollContainer.scrollLeft -= scrollAmount;
                        } else {
                            scrollContainer.scrollLeft += scrollAmount;
                        }
                    }
                }
                
                // Additional keyboard shortcuts
                if (e.key === 'Home') {
                    const activeElement = document.activeElement;
                    const scrollContainer = activeElement.closest('.horizontal-scroll');
                    if (scrollContainer) {
                        e.preventDefault();
                        scrollContainer.scrollLeft = 0;
                    }
                }
                
                if (e.key === 'End') {
                    const activeElement = document.activeElement;
                    const scrollContainer = activeElement.closest('.horizontal-scroll');
                    if (scrollContainer) {
                        e.preventDefault();
                        scrollContainer.scrollLeft = scrollContainer.scrollWidth;
                    }
                }
            });
        }

        // ===========================================
        // NAVIGATION AND SCROLLING FUNCTIONS
        // ===========================================
        
        function scrollSection(sectionId, direction) {
            const container = document.getElementById(sectionId + '-container') || document.getElementById(sectionId);
            if (!container) return;
            
            const scrollAmount = 300;
            const currentScroll = container.scrollLeft;
            
            if (direction === 'left') {
                container.scrollLeft = Math.max(0, currentScroll - scrollAmount);
            } else {
                container.scrollLeft = currentScroll + scrollAmount;
            }
            
            // Update button states
            updateNavigationButtons(container);
        }
        
        function updateNavigationButtons(container) {
            const sectionId = container.id.replace('-container', '');
            const leftBtn = container.parentElement.querySelector('.nav-btn[onclick*="left"]');
            const rightBtn = container.parentElement.querySelector('.nav-btn[onclick*="right"]');
            
            if (leftBtn) {
                leftBtn.disabled = container.scrollLeft <= 0;
            }
            if (rightBtn) {
                rightBtn.disabled = container.scrollLeft >= container.scrollWidth - container.clientWidth;
            }
            
            // Update scroll progress indicator
            updateScrollProgress(container);
        }
        
        function updateScrollProgress(container) {
            const progressBar = container.querySelector('.scroll-progress');
            if (progressBar) {
                const scrollableWidth = container.scrollWidth - container.clientWidth;
                if (scrollableWidth > 0) {
                    const progress = (container.scrollLeft / scrollableWidth) * 100;
                    progressBar.style.width = `${progress}%`;
                } else {
                    progressBar.style.width = '0%';
                }
            }
        }
        
        function setupHorizontalScroll() {
            const scrollContainers = document.querySelectorAll('.horizontal-scroll');
            
            scrollContainers.forEach(container => {

                
                // Touch/swipe support with momentum
                let startX = 0;
                let startY = 0;
                let isScrolling = false;
                let lastScrollTime = 0;
                
                container.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    isScrolling = false;
                    lastScrollTime = Date.now();
                });
                
                container.addEventListener('touchmove', (e) => {
                    if (!isScrolling) {
                        const deltaX = Math.abs(e.touches[0].clientX - startX);
                        const deltaY = Math.abs(e.touches[0].clientY - startY);
                        
                        if (deltaX > deltaY && deltaX > 10) {
                            isScrolling = true;
                        }
                    }
                    
                    if (isScrolling) {
                        e.preventDefault();
                        container.scrollLeft -= e.touches[0].clientX - startX;
                        startX = e.touches[0].clientX;
                        lastScrollTime = Date.now();
                    }
                });
                
                container.addEventListener('touchend', (e) => {
                    if (isScrolling) {
                        const timeDiff = Date.now() - lastScrollTime;
                        if (timeDiff < 100) {
                            // Add momentum scrolling
                            container.classList.add('scrolling');
                            setTimeout(() => {
                                container.classList.remove('scrolling');
                            }, 300);
                        }
                    }
                });
                
                // Update navigation buttons on scroll
                container.addEventListener('scroll', () => {
                    updateNavigationButtons(container);
                });
                
                // Initial button state update
                updateNavigationButtons(container);
            });
        }

        // ===========================================
        // INITIALIZE ON LOAD
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            setupEventListeners();
            setupHorizontalScroll();
            setupAccessibility();
            lucide.createIcons();
        });

        function setupAccessibility() {
            // Add ARIA labels and roles for better screen reader support
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.setAttribute('role', 'button');
                btn.setAttribute('tabindex', '0');
                
                // Add keyboard support for Enter and Space keys
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });
            
            // Add focus indicators for keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-navigation');
                }
            });
            
            document.addEventListener('mousedown', () => {
                document.body.classList.remove('keyboard-navigation');
            });
        }
    </script>
</body>
</html>
